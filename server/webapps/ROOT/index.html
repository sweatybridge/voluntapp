<!DOCTYPE html>
<html>
  <head>
    <title>Login</title>
    <meta charset="UTF-8">
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

    <link rel="stylesheet" href="css/common.css">

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  </head>

  <body>
    <form class="form-centre" role="form" id="login_form" action="user" method="post" autocomplete="on">
      <h2 class="form-heading">Please login</h2>
      <input type="email" name="email" class="form-control" placeholder="Email" autofocus required>
      <input type="password" name="password" class="form-control" placeholder="Password" required>
      <input class="btn btn-primary" type="submit" value="Login">
      <p class="form-error" id="login_errors"></p>
    </form>
    <div class="centre">
    <p>Don't have an account?</p>
    <button type="button" class="btn btn-default" data-toggle="modal" data-target="#registerModal">
      Register now
    </button>
    </div>
    
    <!-- Modal -->
    <div class="modal fade" id="registerModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Register Now</h4>
          </div>
          <div class="modal-body">
            <form class="form-centre" role="form" id="register_form" action="user" method="put" autocomplete="on">
              <div class="form-group"><input type="email" name="email" class="form-control" placeholder="Email" autofocus required></div>
              <div class="form-group"><input type="password" name="password" class="form-control" placeholder="Password" required></div>
              <div class="form-group"><input type="password" name="conf_password" class="form-control" placeholder="Confirm password" required></div>
              <div class="form-group"><input type="text" name="firstName" class="form-control" placeholder="First name" required></div>
              <div class="form-group"><input type="text" name="lastName" class="form-control" placeholder="Last name (optional)"></div>
              <div class="form-group"><input class="btn btn-primary" type="submit" value="Register"></div>
              <p class="form-error" id="register_errors"></p>
            </form>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    
    <script>
      // DOCUMENT READY
      $(function() {
        // Bind forms to ajax
        $("#login_form").submit(function(e) {
          e.preventDefault();
          var form = $(this);
          
          $.ajax(form.attr("action"), {
            data: {payload: JSON.stringify(getFormObj(form))},
            dataType: "json",
            method: "POST",
            statusCode: {
              200: function(data) { window.location.replace("main.html"); },
              400: function(data) { $("#login_errors").text(data.responseJSON.message); }
            }
          });
        });
        
        $("#register_form").submit(function(e) {
          e.preventDefault();
          if (!validateRegister($(this))) {
            return
          }
          
          var form = $(this);
          
          $.ajax(form.attr("action"), {
            data: {payload: JSON.stringify(getFormObj(form))},
            dataType: "json",
            method: "POST",
            statusCode: {
              200: function(data) { window.location.replace("main.html"); },
              400: function(data) { $("#register_errors").text(data.responseJSON.message); }
            }
          });
        });
        
      }); // End of document ready
      
      // Convert input fields into an javascript object
      function getFormObj(form) {
          var formObj = {};
          var inputs = form.serializeArray();
          $.each(inputs, function (i, input) {
              formObj[input.name] = input.value;
          });
          return formObj;
      }
      
      // Register form validation function, called onsubmit
      function validateRegister($form) {
        var form = $form[0];
        var pass_val = form["password"].value;
        
        // Check password length
        if (pass_val.length < 6) {
          //form["password"].setCustomValidity("At least 6 characters long");
          $("#register_errors").text("Password must be at least 6 characters long");
          return false;
        } /*else {
          form["password"].setCustomValidity("");
        }*/
        
        // Check confirmation
        var conf_pass_val = form["conf_password"].value;
        if (pass_val !== conf_pass_val) {
          //form["conf_password"].setCustomValidity("Passwords must match");
          $("#register_errors").text("Password must match");
          return false;
        }/* else {
          form["conf_password"].setCustomValidity("");
        }*/
      }
    </script>
  </body>
</html>
