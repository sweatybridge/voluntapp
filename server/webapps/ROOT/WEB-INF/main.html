<!DOCTYPE html>
<html>
  <head>
    <title>WebApp</title>
    <meta charset="UTF-8">
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/main.css">

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>

    <script src="js/jquery.toaster.js"></script>
  </head>

  <body ng-app="">
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#"><strong>WebApp</strong> beta</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="#">Create</a></li>
            <li><a href="#">Settings</a></li>
            <li><a href="#">Profile</a></li>
            <li><a id="btn_logout" href="#">Logout</a></li>
          </ul>
          <p id="p_loggedinas" class="navbar-text navbar-right">Logged in as <a class="firstName" href="#account" class="navbar-link"></a></p>
        </div>
      </div>
    </nav>
    
    <div class="container-fluid">
      <div class="row">
        <div id="d_left_sidebar" class="col-sm-2">
          <p class="lead">Welcome, <span class="firstName"></span></p>
          <p>You haven't logged in since <strong>{{lastSeen}}</strong></p>
          
          <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
            <div class="panel panel-default">
              <div class="panel-heading" role="tab" id="headingOne">
                <h4 class="panel-title">
                  <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                    My calendars
                  </a>
                </h4>
              </div>
              <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
                <div id="#active_calendars" class="panel-body">
                  It seems like you haven't joined to or created any calendars...
                </div>
              </div>
            </div>
            <div class="panel panel-default">
              <div class="panel-heading" role="tab" id="headingTwo">
                <h4 class="panel-title">
                  <a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                    My profile
                  </a>
                </h4>
              </div>
              <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
                <div class="panel-body">
                  TODO: add in profile form for password update etc.
                </div>
              </div>
            </div>
            <div class="panel panel-default">
              <div class="panel-heading" role="tab" id="headingThree">
                <h4 class="panel-title">
                  <a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                    Settings
                  </a>
                </h4>
              </div>
              <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
                <div class="panel-body">
                  ??
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div id="d_main_col" class="col-sm-8">
          <span class="lead">My events for <strong>&lt;&lt;Jan 1</strong> - <strong>Jan 8&gt;&gt;</strong></span>
          <button id="b_refresh" type="button" class="btn btn-success">Refresh</button>
          <span>Display: </span>
          <div class="btn-group" role="group" aria-label="...">
          <button id="b_hide_left" type="button" class="btn btn-primary active" data-toggle="button">Left sidebar</button>
          <button id="b_hide_weekend" type="button" class="btn btn-primary active" data-toggle="button">Weekend</button>
          <button id="b_hide_right" type="button" class="btn btn-primary active" data-toggle="button">Right sidebar</button>
          </div>
          <table id="t_calendar" class="table">
            <tr>
              <th class="th_weekday">Monday</th>
              <th class="th_weekday">Tuesday</th>
              <th class="th_weekday">Wednesday</th>
              <th class="th_weekday">Thursday</th>
              <th class="th_weekday">Friday</th>
              <th class="th_weekend">Saturday</th>
              <th class="th_weekend">Sunday</th>
            </tr>
            <tr>
              <td>
                <div class="event">
                  <p class="e_title">Campus Tour</p>
                  <span class="e_time">14:00 - 15:00</span>
                  <!--<button type="button" class="btn btn-info btn-sm">v</button>-->
                  <p class="e_desc">Regular campus tour showing prospective students and their parents around the South Kensington Campus</p>
                </div>
              </td>
              <td>data</td>
              <td>data</td>
              <td>data</td>
              <td>data</td>
              <td>data</td>
              <td>data</td>
            </tr>
          </table>
        </div>
        
        <div id="d_right_sidebar" class="col-sm-2">
          <div id="d_right_sidebar" role="tabpanel">
            <!-- Nav tabs -->
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active"><a href="#crt_event" aria-controls="event" role="tab" data-toggle="tab">Event</a></li>
              <li role="presentation"><a href="#crt_calendar" aria-controls="calendar" role="tab" data-toggle="tab">Calendar</a></li>
            </ul>

            <!-- Tab panes -->
            <div class="tab-content">
              <div role="tabpanel" class="tab-pane fade in active" id="crt_event">
                <form class="form-centre" role="form" id="event_form" action="/api/event" method="post" autocomplete="off">
                  <select class="form-control" name="calendar">
                    <option value="volvo">Volvo</option>
                    <option value="saab">Saab</option>
                    <option value="opel">Opel</option>
                    <option value="audi">Audi</option>
                  </select>
                  <input type="text" name="title" class="form-control" placeholder="Title" required>
                  <input type="time" name="startTime" class="form-control" placeholder="Start time" required>
                  <input type="time" name="endTime" class="form-control" placeholder="End time" required>
                  <input type="date" name="date" class="form-control" placeholder="Date" required>
                  <input type="text" name="location" class="form-control" placeholder="Location (Optional)">
                  <input type="number" name="size" class="form-control" min="0" value="0" placeholder="Size" required>
                  <textarea class="form-control" name="description" rows="5" placeholder="Description"></textarea>
                  <input class="btn btn-primary" type="submit" value="Create Event">
                  <p class="form-error" id="event_create_errors"></p>
                </form>
              </div>
              <div role="tabpanel" class="tab-pane fade" id="crt_calendar">
                <p>To join a calendar, you need the calendar token which the administrators of the calendar usually distribute. If you don't know the calendar token, then contact the calendar administrators, if you do, you can join now by entering the token below.</p>
                <form class="form-centre" role="form" id="calendar_join_form" action="calendar" method="post" autocomplete="off">
                  <input type="text" name="token" class="form-control" placeholder="Token" autofocus required>
                  <input class="btn btn-primary" type="submit" value="Join">
                  <p class="form-error" id="calendar_join_errors"></p>
                </form>
                <p>You can create a calendar of which you will be the admin immediately. There isn't any limit on how many calendars you can create. If you want people to start joining your calendar check allow joining. You can change the settings later for your calendar.</p>
                <form class="form-centre" role="form" id="calendar_create_form" action="/api/calendar" method="post" autocomplete="off">
                  <input type="text" name="name" class="form-control" placeholder="Title" required>
                  <div class="checkbox">
                    <label><input type="checkbox" name="allowJoin" value="true">Allow Joining</label>
                  </div>
                  <input class="btn btn-primary" type="submit" value="Create">
                  <p class="form-error" id="calendar_create_errors"></p>
                </form>
              </div>
            </div>

          </div>
        </div>
        
      </div> <!-- End of row -->
    </div> <!-- End of container -->
  
  <script>
    // DOCUMENT READY
    $(function() {
      // Bind weekend collapse
      $("#b_hide_weekend").click(function(){
        // TODO: check if this train reck is the only way to do this
        $("#t_calendar th:nth-of-type(6), #t_calendar td:nth-of-type(6), #t_calendar th:nth-of-type(7), #t_calendar td:nth-of-type(7)").toggle();
      });
      
      // Bind sidebar collapse
      $("#b_hide_left").click(function() {
        $("#d_left_sidebar").toggleClass("col-hidden col-sm-2");
        updateMainCol();
      });
      
      $("#b_hide_right").click(function() {
        $("#d_right_sidebar").toggleClass("col-hidden col-sm-2");
        updateMainCol();        
      });
      
      // Bind event description show button
      $(".event button").click(function() {
        $(this).next(".e_desc").toggle(500);
      });

      // Bind logout button
      $("#btn_logout").click(function() {
        $.ajax("/api/session", {
          method: "DELETE",
          statusCode: {
            200: function(data) {
              window.location.reload()
            },
            400: function(data) { alert(data.responseJSON.message); }
          }
        })
      })

      // Bind event creation form
      $('#event_form').submit(function(e) {
        e.preventDefault()
        var form = $(this)
        $.ajax(form.attr('action'), {
          method: form.attr('method'),
          data: JSON.stringify(getFormObj(form)),
          statusCode: {
            200: function(data) {
              $.toaster({
                priority: 'success',
                message: data.responseJSON.message
              })
            },
            400: function(data) {
              $.toaster({
                priority: 'danger',
                message: data.responseJSON.message
              })
            },
            404: function(data) {
              $.toaster({
                priority: 'danger',
                message: 'Failed to create event.'
              })
            }
          }
        })
      })

      // Bind calendar creation form
      $('#calendar_create_form').submit(function(e) {
        e.preventDefault()
        var form = $(this)
        $.ajax(form.attr('action'), {
          method: form.attr('method'),
          data: JSON.stringify(getFormObj(form)),
          statusCode: {
            200: function(data) {
              $.toaster({
                priority: 'success',
                message: data.message
              })
            },
            400: function(data) {
              $.toaster({
                priority: 'danger',
                message: data.message
              })
            },
            404: function(data) {
              $.toaster({
                priority: 'danger',
                message: 'Failed to create event.'
              })
            }
          }
        })
      })

      // Sets up request headers for all subsequent ajax calls
      $.ajaxSetup({
        contentType: 'application/json; charset=utf-8',
        dataType: 'json',
        beforeSend: function(xhr) {
          xhr.setRequestHeader("Authorization", getCookie("token"))
        }
      })

      // Request user profile information
      $.ajax('/api/user', {
          method: 'GET',
          statusCode: {
              200: function(data) {
                  $('.firstName').text(data.firstName)
              }
          }
      })
    }); // End of document ready

    // Update main column class whether sizebars are hidden or not
    function updateMainCol() {
      var size = 8;
      if ($("#d_right_sidebar").hasClass("col-hidden")) {
        size += 2;
      }
      if ($("#d_left_sidebar").hasClass("col-hidden")) {
        size += 2;
      }
      $("#d_main_col").attr("class", "col-sm-" + size);
    }

    // Temporary function to get auth token from cookie
    function getCookie(name) {
      var value = "; " + document.cookie;
      var parts = value.split("; " + name + "=");
      if (parts.length == 2) return parts.pop().split(";").shift();
    }

    // Convert input fields into an javascript object
    function getFormObj(form) {
      var formObj = {};
      var inputs = form.serializeArray();
      $.each(inputs, function (i, input) {
        formObj[input.name] = input.value;
      });
      return formObj;
    }
  </script>
  </body>
</html>
